<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqupt.yyzx.mapper.BedMapper">

    <!-- 床位结果映射 -->
    <resultMap id="BedResultMap" type="com.cqupt.yyzx.entity.Bed">
        <id property="id" column="id"/>
        <result property="bedNumber" column="bed_number"/>
        <result property="roomId" column="room_id"/>
        <result property="bedType" column="bed_type"/>
        <result property="status" column="status"/>
        <result property="dailyPrice" column="daily_price"/>
        <result property="description" column="description"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <!-- 关联字段 -->
        <result property="roomNumber" column="room_number"/>
        <result property="floorNumber" column="floor_number"/>
        <result property="customerName" column="customer_name"/>
    </resultMap>

    <!-- 房间结果映射 -->
    <resultMap id="RoomResultMap" type="com.cqupt.yyzx.entity.Room">
        <id property="id" column="id"/>
        <result property="roomNumber" column="room_number"/>
        <result property="floorNumber" column="floor_number"/>
        <result property="roomType" column="room_type"/>
        <result property="maxBeds" column="max_beds"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="occupiedBeds" column="occupied_beds"/>
        <result property="availableBeds" column="available_beds"/>
    </resultMap>

    <!-- 分页查询床位列表（包含房间和客户信息） -->
    <select id="selectBedListWithDetails" resultMap="BedResultMap">
        SELECT
        b.id,
        b.bed_number,
        b.room_id,
        b.bed_type,
        b.status,
        b.daily_price,
        b.description,
        b.created_at,
        b.updated_at,
        r.room_number,
        r.floor_number,
        c.name as customer_name
        FROM beds b
        LEFT JOIN rooms r ON b.room_id = r.id
        LEFT JOIN customers c ON b.id = c.bed_id AND c.status = 1
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                b.bed_number LIKE CONCAT('%', #{searchKeyword}, '%')
                OR r.room_number LIKE CONCAT('%', #{searchKeyword}, '%')
                OR c.name LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND b.status = #{status}
            </if>
            <if test="floorNumber != null">
                AND r.floor_number = #{floorNumber}
            </if>
        </where>
        ORDER BY r.floor_number, r.room_number, b.bed_number
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 查询床位总数 -->
    <select id="countBeds" resultType="Integer">
        SELECT COUNT(*)
        FROM beds b
        LEFT JOIN rooms r ON b.room_id = r.id
        LEFT JOIN customers c ON b.id = c.bed_id AND c.status = 1
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                b.bed_number LIKE CONCAT('%', #{searchKeyword}, '%')
                OR r.room_number LIKE CONCAT('%', #{searchKeyword}, '%')
                OR c.name LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND b.status = #{status}
            </if>
            <if test="floorNumber != null">
                AND r.floor_number = #{floorNumber}
            </if>
        </where>
    </select>

    <!-- 根据ID查询床位详细信息 -->
    <select id="selectBedById" resultMap="BedResultMap">
        SELECT
            b.id,
            b.bed_number,
            b.room_id,
            b.bed_type,
            b.status,
            b.daily_price,
            b.description,
            b.created_at,
            b.updated_at,
            r.room_number,
            r.floor_number,
            c.name as customer_name
        FROM beds b
                 LEFT JOIN rooms r ON b.room_id = r.id
                 LEFT JOIN customers c ON b.id = c.bed_id AND c.status = 1
        WHERE b.id = #{id}
    </select>

    <!-- 根据床位号查询床位 -->
    <select id="selectBedByNumber" resultMap="BedResultMap">
        SELECT * FROM beds WHERE bed_number = #{bedNumber}
    </select>

    <!-- 插入新床位 -->
    <insert id="insertBed" parameterType="com.cqupt.yyzx.entity.Bed" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO beds (
            bed_number,
            room_id,
            bed_type,
            status,
            daily_price,
            description,
            created_at,
            updated_at
        )
        VALUES (
                   #{bedNumber},
                   #{roomId},
                   #{bedType},
                   #{status},
                   #{dailyPrice},
                   #{description},
                   NOW(),
                   NOW()
               )
    </insert>

    <!-- 更新床位信息 -->
    <update id="updateBed" parameterType="com.cqupt.yyzx.entity.Bed">
        UPDATE beds
        SET
            bed_number = #{bedNumber},
            room_id = #{roomId},
            bed_type = #{bedType},
            status = #{status},
            daily_price = #{dailyPrice},
            description = #{description},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除床位 -->
    <delete id="deleteBed">
        DELETE FROM beds WHERE id = #{id}
    </delete>

    <!-- 批量删除床位 -->
    <delete id="deleteBeds">
        DELETE FROM beds WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <!-- 更新床位状态 -->
    <update id="updateBedStatus">
        UPDATE beds
        SET status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 查询所有房间信息 -->
    <select id="selectAllRooms" resultMap="RoomResultMap">
        SELECT
            r.*,
            COALESCE(bed_stats.occupied_beds, 0) as occupied_beds,
            COALESCE(r.max_beds - bed_stats.occupied_beds, r.max_beds) as available_beds
        FROM rooms r
                 LEFT JOIN (
            SELECT
                room_id,
                COUNT(*) as occupied_beds
            FROM beds
            WHERE status = '占用'
            GROUP BY room_id
        ) bed_stats ON r.id = bed_stats.room_id
        WHERE r.status = 1
        ORDER BY r.floor_number, r.room_number
    </select>

    <!-- 根据房间ID查询床位列表 -->
    <select id="selectBedsByRoomId" resultMap="BedResultMap">
        SELECT * FROM beds
        WHERE room_id = #{roomId}
        ORDER BY bed_number
    </select>

    <!-- 床位状态统计 -->
    <select id="getBedStatusStats" resultType="java.util.Map">
        SELECT
            status,
            COUNT(*) as count
        FROM beds
        GROUP BY status
    </select>

    <!-- 检查床位号是否已存在 -->
    <select id="checkBedNumberExists" resultType="Integer">
        SELECT COUNT(*) FROM beds
        WHERE bed_number = #{bedNumber}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

</mapper>